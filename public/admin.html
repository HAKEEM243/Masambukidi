<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/static/logo-elucco.png">
  <link rel="shortcut icon" type="image/png" href="/static/logo-elucco.png">
  <title>Administration — E.LU.C.CO. · Système de Protection Officiel</title>
  <meta name="robots" content="noindex, nofollow">
  <meta name="description" content="Interface d'administration — E.LU.C.CO. — Système de protection officiel des droits de Sa Majesté Masambukidi I">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --gold: #C9A227;
      --gold-light: #E8C84A;
      --gold-dark: #9B7A1A;
      --bg: #07070E;
      --bg-card: #0D0D18;
      --bg-panel: #111122;
      --border: #1C1C2E;
      --border-light: #262640;
      --text: #EEEAE4;
      --text-muted: #8A8799;
      --text-dim: #5A5870;
      --success: #1F7A3A;
      --danger: #7A1F1F;
      --warning: #7A5A1F;
      --info: #1F3A7A;
      --sidebar-w: 260px;
    }
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--gold-dark); border-radius: 3px; }

    /* LOGIN */
    #loginScreen {
      position: fixed; inset: 0; z-index: 9999;
      background: radial-gradient(ellipse at center, #0A0A18 0%, #050508 100%);
      display: flex; align-items: center; justify-content: center;
    }
    .login-box {
      width: 420px;
      background: var(--bg-card);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      padding: 48px 40px;
      box-shadow: 0 40px 120px rgba(0,0,0,0.8);
    }
    .login-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .login-logo {
      width: 80px; height: 80px;
      object-fit: contain;
      margin-bottom: 16px;
    }
    .login-title {
      font-family: 'Playfair Display', serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 4px;
    }
    .login-subtitle {
      font-size: 12px;
      color: var(--text-dim);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .field-group { margin-bottom: 20px; }
    .field-group label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .field-input {
      width: 100%;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-light);
      color: var(--text);
      padding: 13px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .field-input:focus {
      outline: none;
      border-color: rgba(201,162,39,0.5);
      box-shadow: 0 0 0 3px rgba(201,162,39,0.08);
    }
    .field-input::placeholder { color: var(--text-dim); }
    .btn-login {
      width: 100%;
      background: var(--gold);
      color: var(--bg);
      border: none;
      padding: 14px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.5px;
    }
    .btn-login:hover { background: var(--gold-light); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(201,162,39,0.25); }
    .login-error {
      background: rgba(122,31,31,0.2);
      border: 1px solid rgba(122,31,31,0.4);
      color: #ff8080;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 16px;
      display: none;
      text-align: center;
    }
    .login-error.show { display: block; }

    /* LAYOUT */
    #adminApp { display: none; height: 100vh; overflow: hidden; }

    /* SIDEBAR */
    .sidebar {
      position: fixed; top: 0; left: 0;
      width: var(--sidebar-w);
      height: 100vh;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      overflow-y: auto;
      z-index: 100;
    }
    .sidebar-brand {
      padding: 24px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
    }
    .sidebar-brand img { height: 40px; object-fit: contain; }
    .sidebar-brand-text .title {
      font-size: 13px; font-weight: 700; color: var(--gold);
    }
    .sidebar-brand-text .sub {
      font-size: 10px; color: var(--text-dim); letter-spacing: 0.5px;
    }
    .sidebar-nav { padding: 16px 12px; flex: 1; }
    .nav-section {
      font-size: 10px; font-weight: 700; color: var(--text-dim);
      letter-spacing: 2px; text-transform: uppercase;
      padding: 16px 8px 8px;
    }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      position: relative;
    }
    .nav-item:hover { background: rgba(255,255,255,0.04); color: var(--text); }
    .nav-item.active {
      background: rgba(201,162,39,0.1);
      color: var(--gold);
      border: 1px solid rgba(201,162,39,0.15);
    }
    .nav-item .nav-icon { width: 18px; text-align: center; font-size: 14px; }
    .nav-badge {
      margin-left: auto;
      background: var(--danger);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }
    .sidebar-footer {
      padding: 16px 12px;
      border-top: 1px solid var(--border);
    }
    .sidebar-user {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      background: rgba(201,162,39,0.06);
      border: 1px solid rgba(201,162,39,0.1);
    }
    .user-avatar {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #C9A227, #9B7A1A);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: var(--bg);
      font-size: 15px;
      font-weight: 700;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(201,162,39,0.25);
    }
    .user-name { font-size: 12px; font-weight: 700; color: var(--text); }
    .user-role {
      font-size: 10px; color: var(--gold); font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
      background: rgba(201,162,39,0.08);
      padding: 1px 7px; border-radius: 4px;
      display: inline-block; margin-top: 2px;
    }
    .btn-logout {
      width: 100%; margin-top: 8px;
      background: transparent; border: 1px solid var(--border-light);
      color: var(--text-muted); padding: 8px;
      border-radius: 8px; cursor: pointer;
      font-size: 12px; transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .btn-logout:hover { border-color: rgba(122,31,31,0.5); color: #ff8080; }

    /* MAIN */
    .main {
      margin-left: var(--sidebar-w);
      height: 100vh;
      overflow-y: auto;
      display: flex; flex-direction: column;
    }
    .topbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 32px;
      height: 64px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 50;
    }
    .topbar-title {
      font-size: 18px; font-weight: 700; color: var(--text);
      font-family: 'Playfair Display', serif;
    }
    .topbar-actions { display: flex; gap: 8px; align-items: center; }
    .topbar-btn {
      background: transparent; border: 1px solid var(--border-light);
      color: var(--text-muted); padding: 8px 16px;
      border-radius: 8px; cursor: pointer; font-size: 13px;
      transition: all 0.2s; font-family: 'Inter', sans-serif;
      display: flex; align-items: center; gap: 6px;
    }
    .topbar-btn:hover { border-color: rgba(201,162,39,0.4); color: var(--gold); }
    .topbar-btn.primary {
      background: var(--gold); border-color: var(--gold);
      color: var(--bg); font-weight: 600;
    }
    .topbar-btn.primary:hover { background: var(--gold-light); color: var(--bg); }

    /* CONTENT */
    .content { padding: 32px; flex: 1; }

    /* SECTIONS */
    .section { display: none; }
    .section.active { display: block; }

    /* KPI GRID */
    .kpi-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 20px; margin-bottom: 32px;
    }
    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 24px;
      transition: border-color 0.2s;
    }
    .kpi-card:hover { border-color: var(--border-light); }
    .kpi-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .kpi-label { font-size: 12px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-icon {
      width: 36px; height: 36px;
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
    }
    .kpi-number {
      font-size: 36px; font-weight: 700; color: var(--text);
      font-family: 'Playfair Display', serif;
      line-height: 1;
      margin-bottom: 6px;
    }
    .kpi-trend { font-size: 12px; color: var(--text-dim); }
    .kpi-trend .up { color: #4CAF50; }
    .kpi-trend .down { color: #F44336; }

    /* TABLES */
    .table-wrapper {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
    }
    .table-header h3 { font-size: 15px; font-weight: 600; color: var(--text); }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      padding: 12px 16px; text-align: left;
      font-size: 11px; font-weight: 700; color: var(--text-dim);
      letter-spacing: 1px; text-transform: uppercase;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid var(--border);
    }
    tbody tr {
      border-bottom: 1px solid rgba(255,255,255,0.03);
      transition: background 0.15s;
    }
    tbody tr:hover { background: rgba(255,255,255,0.02); }
    tbody tr:last-child { border-bottom: none; }
    tbody td { padding: 14px 16px; font-size: 13px; color: var(--text-muted); }
    .td-main { color: var(--text); font-weight: 500; }

    /* BADGES */
    .badge {
      display: inline-flex; align-items: center;
      padding: 3px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600; letter-spacing: 0.3px;
    }
    .badge-pending { background: rgba(122,90,31,0.2); color: #FFBA00; border: 1px solid rgba(122,90,31,0.3); }
    .badge-processing { background: rgba(31,58,122,0.2); color: #5B9BFF; border: 1px solid rgba(31,58,122,0.3); }
    .badge-resolved { background: rgba(31,122,58,0.2); color: #4CAF50; border: 1px solid rgba(31,122,58,0.3); }
    .badge-rejected { background: rgba(100,100,100,0.15); color: #888; border: 1px solid rgba(100,100,100,0.2); }
    .badge-legal { background: rgba(122,31,31,0.2); color: #FF5252; border: 1px solid rgba(122,31,31,0.3); }
    .badge-draft { background: rgba(122,90,31,0.15); color: #C9A227; border: 1px solid rgba(122,90,31,0.2); }
    .badge-signed { background: rgba(31,122,58,0.15); color: #4CAF50; border: 1px solid rgba(31,122,58,0.2); }

    /* ACTIONS */
    .action-btn {
      background: transparent; border: 1px solid var(--border-light);
      color: var(--text-muted); padding: 6px 12px;
      border-radius: 6px; cursor: pointer; font-size: 12px;
      transition: all 0.2s; font-family: 'Inter', sans-serif;
      display: inline-flex; align-items: center; gap: 5px;
    }
    .action-btn:hover { border-color: rgba(201,162,39,0.4); color: var(--gold); }
    .action-btn.danger:hover { border-color: rgba(122,31,31,0.5); color: #ff8080; }
    .action-btn.primary-sm {
      background: rgba(201,162,39,0.1); border-color: rgba(201,162,39,0.3);
      color: var(--gold);
    }

    /* MODALS */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      z-index: 1000; display: none; align-items: center; justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg-panel);
      border: 1px solid var(--border-light);
      border-radius: 18px;
      width: 680px; max-width: 95vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 40px 120px rgba(0,0,0,0.8);
    }
    .modal-head {
      padding: 24px 28px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; background: var(--bg-panel); z-index: 1;
    }
    .modal-head h3 { font-size: 16px; font-weight: 700; color: var(--text); font-family: 'Playfair Display', serif; }
    .modal-close {
      width: 32px; height: 32px;
      background: rgba(255,255,255,0.05); border: none;
      border-radius: 8px; cursor: pointer; color: var(--text-muted);
      font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
    }
    .modal-close:hover { background: rgba(122,31,31,0.2); color: #ff8080; }
    .modal-body { padding: 28px; }
    .modal-footer {
      padding: 20px 28px;
      border-top: 1px solid var(--border);
      display: flex; gap: 12px; justify-content: flex-end;
    }

    /* FORM ELEMENTS */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block; font-size: 12px; font-weight: 600;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.5px; margin-bottom: 8px;
    }
    select.field-input, textarea.field-input {
      appearance: none; resize: vertical;
    }
    .form-select {
      width: 100%; background: rgba(255,255,255,0.04);
      border: 1px solid var(--border-light); color: var(--text);
      padding: 12px 16px; border-radius: 10px; font-size: 14px;
      font-family: 'Inter', sans-serif; transition: border-color 0.2s;
      appearance: none; cursor: pointer;
    }
    .form-select:focus { outline: none; border-color: rgba(201,162,39,0.5); }
    .form-select option { background: var(--bg-panel); }

    /* ALERTS */
    .alert-info {
      background: rgba(31,58,122,0.15); border: 1px solid rgba(31,58,122,0.3);
      border-radius: 10px; padding: 14px 18px; font-size: 13px;
      color: #7EB8FF; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;
    }

    /* DOCUMENT PREVIEW */
    .doc-iframe {
      width: 100%;
      height: 70vh;
      border: none;
      border-radius: 8px;
      background: #fff;
    }
    .doc-open-btn {
      display: flex; align-items: center; gap: 8px;
      background: rgba(201,162,39,0.1); border: 1px solid rgba(201,162,39,0.3);
      color: var(--gold); padding: 8px 16px; border-radius: 8px;
      cursor: pointer; font-size: 13px; font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    .doc-open-btn:hover { background: rgba(201,162,39,0.2); }

    /* SIGNATURE AREA */
    .sig-canvas-wrapper {
      border: 2px dashed var(--border-light);
      border-radius: 10px; overflow: hidden; margin-bottom: 12px;
      position: relative; background: #fff;
    }
    #sigCanvas { display: block; cursor: crosshair; touch-action: none; }
    .sig-clear {
      background: transparent; border: 1px solid var(--border-light);
      color: var(--text-muted); padding: 6px 12px; border-radius: 6px;
      cursor: pointer; font-size: 12px; font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }
    .sig-clear:hover { border-color: rgba(122,31,31,0.4); color: #ff8080; }

    /* MONITORING */
    .monitor-status {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: var(--text-muted);
    }
    .monitor-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #4CAF50;
      animation: blink 2s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* BANNIÈRE INSTITUTIONNELLE */
    .inst-banner {
      background: linear-gradient(135deg, #0A0A1A 0%, #0D1A0D 100%);
      border-bottom: 1px solid rgba(201,162,39,0.15);
      padding: 8px 32px;
      display: flex; align-items: center; justify-content: space-between;
      font-size: 11px; color: var(--text-dim);
      letter-spacing: 0.3px;
    }
    .inst-banner-left { display: flex; align-items: center; gap: 20px; }
    .inst-banner-pill {
      background: rgba(201,162,39,0.06); border: 1px solid rgba(201,162,39,0.12);
      color: #9A7A1A; padding: 2px 10px; border-radius: 20px; font-size: 10px;
      font-weight: 700; letter-spacing: 0.8px; text-transform: uppercase;
    }
    .inst-banner-right { display: flex; align-items: center; gap: 6px; color: #4A6A4A; }
    .inst-banner-right span { color: #4CAF50; font-weight: 700; font-size: 10px; }

    /* EMPTY STATE */
    .empty-state {
      text-align: center; padding: 60px 20px;
      color: var(--text-dim);
    }
    .empty-state i { font-size: 40px; margin-bottom: 12px; color: var(--border-light); display: block; }
    .empty-state p { font-size: 14px; }

    /* SCROLLBAR INSIDE MODAL */
    .modal::-webkit-scrollbar { width: 4px; }
    .modal::-webkit-scrollbar-thumb { background: var(--gold-dark); }

    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .main { margin-left: 0; }
      .kpi-grid { grid-template-columns: 1fr 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- BANNIÈRE INSTITUTIONNELLE (hors admin app, visible avant login) -->
<div id="instBannerTop" style="display:none; background:linear-gradient(90deg,#0A0A1A,#0D1A0D); border-bottom:1px solid rgba(201,162,39,0.12); padding:6px 32px; display:flex; align-items:center; justify-content:space-between; font-size:10.5px; color:#5A5870; letter-spacing:0.3px;">
  <div style="display:flex;align-items:center;gap:16px;">
    <span style="color:#7A6A1A;font-weight:700;text-transform:uppercase;letter-spacing:1px;">CONFIDENTIEL</span>
    <span>Système de Protection Officiel — E.LU.C.CO.</span>
    <span style="color:#4A5A4A;">Ord. Présidentielle N° 97-031 du 14 Mars 1997 · Kinshasa, R.D.C.</span>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <div style="width:6px;height:6px;border-radius:50%;background:#4CAF50;"></div>
    <span style="color:#4A6A4A;font-size:10px;">Système opérationnel</span>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-header">
      <img src="/static/logo-elucco.png" alt="E.LU.C.CO." class="login-logo">
      <div class="login-title">Administration Officielle</div>
      <div class="login-subtitle">E.LU.C.CO. — Accès Restreint</div>
      <div style="margin-top:10px;font-size:10px;color:#3A3A5A;border:1px solid rgba(201,162,39,0.08);background:rgba(201,162,39,0.03);padding:6px 12px;border-radius:6px;letter-spacing:0.5px;">SYSTÈME DE PROTECTION OFFICIEL · KINSHASA, R.D.C.</div>
    </div>
    <form onsubmit="event.preventDefault(); doLogin();" autocomplete="on">
      <div class="field-group">
        <label>Identifiant</label>
        <input type="text" id="loginUser" name="username" class="field-input" placeholder="admin" autocomplete="username">
      </div>
      <div class="field-group">
        <label>Mot de passe</label>
        <input type="password" id="loginPass" name="password" class="field-input" placeholder="••••••••" autocomplete="current-password">
      </div>
      <button type="submit" class="btn-login">
        <i class="fas fa-sign-in-alt" style="margin-right:8px;"></i>Se connecter
      </button>
    </form>
    <div id="loginError" class="login-error"></div>
    <div style="margin-top: 24px; text-align: center;">
      <a href="/" style="color: var(--text-dim); font-size: 12px; text-decoration: none;">
        <i class="fas fa-arrow-left" style="margin-right:4px;"></i>Retour au site public
      </a>
    </div>
  </div>
</div>

<!-- APP -->
<div id="adminApp">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div style="background:linear-gradient(135deg,#0A0A14,#0D150D);padding:0 0 8px;">
      <div style="padding:16px 20px 10px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(201,162,39,0.1);">
        <img src="/static/logo-elucco.png" alt="Logo" style="height:38px;object-fit:contain;">
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--gold);line-height:1.2;">E.LU.C.CO.</div>
          <div style="font-size:9px;color:var(--text-dim);letter-spacing:0.5px;text-transform:uppercase;">Administration Officielle</div>
        </div>
      </div>
      <div style="padding:6px 20px;font-size:9px;color:#3A3A5A;text-align:center;letter-spacing:0.5px;">ORD. N° 97-031 · 14 MARS 1997</div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" onclick="showSection('dashboard', this)">
        <i class="fas fa-chart-line nav-icon"></i> Tableau de bord
      </div>
      <div class="nav-item" onclick="showSection('reports', this)">
        <i class="fas fa-flag nav-icon"></i> Signalements
        <span class="nav-badge" id="navBadgePending">0</span>
      </div>

      <div class="nav-section">Juridique</div>
      <div class="nav-item" onclick="showSection('legal', this)">
        <i class="fas fa-gavel nav-icon"></i> Dossiers juridiques
      </div>
      <div class="nav-item" onclick="showSection('permissions', this)">
        <i class="fas fa-file-signature nav-icon"></i> Autorisations
      </div>

      <div class="nav-section">Gestion</div>
      <div class="nav-item" onclick="showSection('whitelist', this)">
        <i class="fas fa-check-double nav-icon"></i> Contenus autorisés
      </div>
      <div class="nav-item" onclick="showSection('alerts', this)">
        <i class="fas fa-bell nav-icon"></i> Alertes surveillance
      </div>
    </nav>

    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="user-avatar">M</div>
        <div>
          <div class="user-name" id="sidebarUserName">Administrateur Masambukidi</div>
          <div class="user-role">Superadmin</div>
        </div>
      </div>
      <button class="btn-logout" onclick="doLogout()">
        <i class="fas fa-sign-out-alt" style="margin-right:6px;"></i>Déconnexion
      </button>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div style="background:var(--bg-card);border-bottom:1px solid rgba(201,162,39,0.08);padding:6px 32px;font-size:10px;color:#3A3A5A;display:flex;align-items:center;justify-content:space-between;">
      <span>ÉGLISE LUMIÈRE DU CHRIST AU CONGO (E.LU.C.CO.) &nbsp;·&nbsp; Système de Protection des Droits &nbsp;·&nbsp; Ord. N° 97-031 du 14 Mars 1997</span>
      <span id="adminClockBanner" style="color:#3A4A3A;font-family:monospace;"></span>
    </div>
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:12px;">
        <div style="width:3px;height:22px;background:var(--gold);border-radius:2px;"></div>
        <div class="topbar-title" id="topbarTitle">Tableau de bord</div>
      </div>
      <div class="topbar-actions">
        <div class="monitor-status">
          <div class="monitor-dot"></div>
          Surveillance active
        </div>
        <button class="topbar-btn" onclick="loadDashboard();loadReports();loadLegalCases();" title="Rafraîchir les données">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button class="topbar-btn primary" onclick="showSection('reports', document.querySelector('[onclick*=reports]'))">
          <i class="fas fa-plus"></i> Nouveau signalement
        </button>
      </div>
    </div>

    <div class="content">

      <!-- DASHBOARD -->
      <div id="section-dashboard" class="section active">
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Signalements</div>
              <div class="kpi-icon" style="background:rgba(201,162,39,0.1);color:var(--gold);">
                <i class="fas fa-flag"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-total">—</div>
            <div class="kpi-trend">Cette semaine : <span class="up" id="ds-week">—</span></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">En attente</div>
              <div class="kpi-icon" style="background:rgba(122,90,31,0.15);color:#FFBA00;">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-pending">—</div>
            <div class="kpi-trend">À traiter en priorité</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Résolus</div>
              <div class="kpi-icon" style="background:rgba(31,122,58,0.15);color:#4CAF50;">
                <i class="fas fa-check-circle"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-resolved">—</div>
            <div class="kpi-trend">Contenus retirés avec succès</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Actions légales</div>
              <div class="kpi-icon" style="background:rgba(122,31,31,0.15);color:#FF5252;">
                <i class="fas fa-gavel"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-legal">—</div>
            <div class="kpi-trend">Dossiers actifs</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Autorisations</div>
              <div class="kpi-icon" style="background:rgba(31,58,122,0.15);color:#5B9BFF;">
                <i class="fas fa-file-contract"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-perms">—</div>
            <div class="kpi-trend">Demandes reçues</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Contenus autorisés</div>
              <div class="kpi-icon" style="background:rgba(31,122,58,0.1);color:#4CAF50;">
                <i class="fas fa-shield-alt"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-auth">—</div>
            <div class="kpi-trend">Liste blanche active</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Dossiers juridiques</div>
              <div class="kpi-icon" style="background:rgba(201,162,39,0.08);color:var(--gold);">
                <i class="fas fa-folder-open"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-cases">—</div>
            <div class="kpi-trend">Documents générés</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-top">
              <div class="kpi-label">Nouvelles alertes</div>
              <div class="kpi-icon" style="background:rgba(122,31,31,0.12);color:#FF5252;">
                <i class="fas fa-bell"></i>
              </div>
            </div>
            <div class="kpi-number" id="ds-alerts">—</div>
            <div class="kpi-trend">Surveillance IA</div>
          </div>
        </div>

        <!-- Recent Reports -->
        <div class="table-wrapper">
          <div class="table-header">
            <h3>Signalements récents</h3>
            <button class="action-btn primary-sm" onclick="showSection('reports', null)">Voir tout</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Référence</th>
                <th>Plateforme</th>
                <th>Type</th>
                <th>Statut</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="dashboardRecentReports">
              <tr><td colspan="5"><div class="empty-state"><i class="fas fa-inbox"></i><p>Chargement...</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- REPORTS -->
      <div id="section-reports" class="section">
        <div class="table-wrapper">
          <div class="table-header">
            <h3>Tous les signalements</h3>
            <div style="display:flex;gap:8px;">
              <select class="form-select" style="width:160px;" onchange="loadReports(this.value)">
                <option value="">Tous les statuts</option>
                <option value="pending">En attente</option>
                <option value="processing">En cours</option>
                <option value="resolved">Résolus</option>
                <option value="legal_action">Action légale</option>
              </select>
              <button class="topbar-btn primary" onclick="openModal('modalNewReport')">
                <i class="fas fa-plus"></i> Créer
              </button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Référence</th>
                <th>URL / Plateforme</th>
                <th>Type d'abus</th>
                <th>Signalé par</th>
                <th>Priorité</th>
                <th>Statut</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="reportsTable">
              <tr><td colspan="8"><div class="empty-state"><i class="fas fa-flag"></i><p>Aucun signalement</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- LEGAL -->
      <div id="section-legal" class="section">
        <div class="table-wrapper">
          <div class="table-header">
            <h3>Dossiers juridiques</h3>
            <button class="topbar-btn primary" onclick="openModal('modalNewCase')">
              <i class="fas fa-plus"></i> Nouveau dossier
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Numéro</th>
                <th>Type</th>
                <th>Contrevenant</th>
                <th>Plateforme</th>
                <th>Statut</th>
                <th>Créé le</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="legalTable">
              <tr><td colspan="7"><div class="empty-state"><i class="fas fa-gavel"></i><p>Aucun dossier</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PERMISSIONS -->
      <div id="section-permissions" class="section">
        <div class="table-wrapper">
          <div class="table-header">
            <h3>Demandes d'autorisation</h3>
          </div>
          <table>
            <thead>
              <tr>
                <th>Ticket</th>
                <th>Demandeur</th>
                <th>Organisation</th>
                <th>Objet</th>
                <th>Commercial</th>
                <th>Statut</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="permissionsTable">
              <tr><td colspan="8"><div class="empty-state"><i class="fas fa-file-signature"></i><p>Aucune demande</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- WHITELIST -->
      <div id="section-whitelist" class="section">
        <div class="table-wrapper">
          <div class="table-header">
            <h3>Contenus officiellement autorisés</h3>
            <button class="topbar-btn primary" onclick="openModal('modalAddWhitelist')">
              <i class="fas fa-plus"></i> Ajouter
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Certificat</th>
                <th>Bénéficiaire</th>
                <th>Type</th>
                <th>URL</th>
                <th>Expiration</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="whitelistTable">
              <tr><td colspan="6"><div class="empty-state"><i class="fas fa-shield-alt"></i><p>Aucun contenu autorisé</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ALERTS -->
      <div id="section-alerts" class="section">
        <div class="alert-info">
          <i class="fas fa-info-circle"></i>
          Surveillance automatique active — Facebook, YouTube, Instagram, TikTok, Twitter, Google
        </div>

        <!-- Abonnés aux alertes -->
        <div class="table-wrapper" style="margin-bottom: 24px;">
          <div class="table-header">
            <h3>Abonnés aux Alertes</h3>
            <button class="topbar-btn" onclick="loadSubscribers()">
              <i class="fas fa-sync-alt"></i> Rafraîchir
            </button>
          </div>
          <div id="subscribersContainer">
            <div style="padding: 20px; text-align: center; color: var(--text-muted);">Chargement...</div>
          </div>
        </div>

        <!-- Broadcast manuel -->
        <div class="table-wrapper" style="margin-bottom: 24px;">
          <div class="table-header">
            <h3>Diffuser une Alerte</h3>
          </div>
          <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label>Mot-clé détecté</label>
              <input type="text" id="broadcastKeyword" class="field-input" placeholder="ex: masambukidi">
            </div>
            <div class="form-group">
              <label>Plateforme</label>
              <select id="broadcastPlatform" class="form-select">
                <option value="facebook">Facebook</option>
                <option value="youtube">YouTube</option>
                <option value="instagram">Instagram</option>
                <option value="tiktok">TikTok</option>
                <option value="twitter">Twitter/X</option>
                <option value="other">Autre</option>
              </select>
            </div>
            <div class="form-group">
              <label>Titre du contenu</label>
              <input type="text" id="broadcastTitle" class="field-input" placeholder="Titre du contenu détecté">
            </div>
            <div class="form-group">
              <label>URL du contenu</label>
              <input type="text" id="broadcastUrl" class="field-input" placeholder="https://...">
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Description</label>
              <textarea id="broadcastDesc" class="field-input" rows="2" placeholder="Description du contenu problématique..."></textarea>
            </div>
          </div>
          <div style="padding: 0 20px 20px; display: flex; gap: 12px; align-items: center;">
            <button class="topbar-btn primary" onclick="broadcastAlert()">
              <i class="fas fa-broadcast-tower"></i> Envoyer l'alerte à tous les abonnés
            </button>
            <span id="broadcastStatus" style="font-size: 13px; color: var(--text-muted);"></span>
          </div>
        </div>

        <!-- Alertes de surveillance -->
        <div class="table-wrapper">
          <div class="table-header">
            <h3>Alertes de surveillance</h3>
            <button class="topbar-btn" onclick="loadAlerts()">
              <i class="fas fa-sync-alt"></i> Rafraîchir
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Mot-clé</th>
                <th>Plateforme</th>
                <th>Titre détecté</th>
                <th>URL</th>
                <th>Priorité</th>
                <th>Détecté le</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="alertsTable">
              <tr><td colspan="7"><div class="empty-state"><i class="fas fa-bell"></i><p>Aucune alerte</p></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /adminApp -->

<!-- ==================== MODALS ==================== -->

<!-- PROCESS REPORT MODAL -->
<div id="modalProcessReport" class="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <h3>Traitement du signalement</h3>
      <button class="modal-close" onclick="closeModal('modalProcessReport')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="processReportId">
      <div class="form-row">
        <div class="form-group">
          <label>Nouveau statut</label>
          <select id="processStatus" class="form-select">
            <option value="processing">En cours de traitement</option>
            <option value="resolved">Résolu</option>
            <option value="rejected">Rejeté</option>
            <option value="legal_action">Action légale</option>
          </select>
        </div>
        <div class="form-group">
          <label>Priorité</label>
          <select id="processPriority" class="form-select">
            <option value="normal">Normale</option>
            <option value="high">Haute</option>
            <option value="critical">Critique</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Actions entreprises</label>
        <textarea id="processActions" class="field-input" rows="3" placeholder="Décrivez les actions prises..."></textarea>
      </div>
      <div class="form-group">
        <label>Notes internes</label>
        <textarea id="processNotes" class="field-input" rows="2" placeholder="Notes confidentielles..."></textarea>
      </div>
      <div class="form-row" id="offenderFields">
        <div class="form-group">
          <label>Nom du contrevenant</label>
          <input type="text" id="offenderName" class="field-input" placeholder="Nom complet">
        </div>
        <div class="form-group">
          <label>Email du contrevenant</label>
          <input type="email" id="offenderEmail" class="field-input" placeholder="email@exemple.com">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-btn" onclick="closeModal('modalProcessReport')">Annuler</button>
      <button class="topbar-btn primary" onclick="submitProcessReport()">
        <i class="fas fa-save"></i> Enregistrer
      </button>
    </div>
  </div>
</div>

<!-- NEW LEGAL CASE -->
<div id="modalNewCase" class="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <h3>Créer un dossier juridique</h3>
      <button class="modal-close" onclick="closeModal('modalNewCase')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Signalement associé (ID)</label>
        <input type="number" id="caseReportId" class="field-input" placeholder="ID du signalement">
      </div>
      <div class="form-group">
        <label>Type de document</label>
        <select id="caseType" class="form-select">
          <option value="mise_en_demeure">Mise en demeure</option>
          <option value="plainte_formelle">Plainte formelle</option>
          <option value="injonction">Injonction de retrait</option>
        </select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nom du contrevenant</label>
          <input type="text" id="caseOffenderName" class="field-input" placeholder="Nom complet ou pseudonyme">
        </div>
        <div class="form-group">
          <label>Email du contrevenant</label>
          <input type="email" id="caseOffenderEmail" class="field-input" placeholder="email@exemple.com">
        </div>
      </div>
      <div class="form-group">
        <label>Identifiant plateforme</label>
        <input type="text" id="caseOffenderPlatformId" class="field-input" placeholder="@username, page ID, URL...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-btn" onclick="closeModal('modalNewCase')">Annuler</button>
      <button class="topbar-btn primary" onclick="submitNewCase()">
        <i class="fas fa-file-alt"></i> Générer le document
      </button>
    </div>
  </div>
</div>

<!-- VIEW/SIGN LEGAL DOCUMENT -->
<div id="modalViewDoc" class="modal-overlay">
  <div class="modal" style="width: 800px;">
    <div class="modal-head">
      <h3>Document juridique</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="action-btn primary-sm" onclick="printCurrentDoc()"><i class="fas fa-print"></i> Imprimer</button>
        <button class="modal-close" onclick="closeModal('modalViewDoc')"><i class="fas fa-times"></i></button>
      </div>
    </div>
    <div class="modal-body">
      <div id="docPreviewArea"></div>

      <!-- SIGNATURE PAD -->
      <div id="signatureArea" style="margin-top: 32px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--gold); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
          <i class="fas fa-pen-nib" style="margin-right: 6px;"></i>Signature électronique officielle
        </div>
        <div class="sig-canvas-wrapper">
          <canvas id="sigCanvas" width="700" height="160"></canvas>
        </div>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <button class="sig-clear" onclick="clearSignature()"><i class="fas fa-eraser"></i> Effacer</button>
          <span style="font-size:11px;color:var(--text-dim);align-self:center;">Signez dans le cadre blanc ci-dessus</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-btn" onclick="closeModal('modalViewDoc')">Fermer</button>
      <button class="topbar-btn primary" onclick="signCurrentDoc()">
        <i class="fas fa-stamp"></i> Signer et valider
      </button>
    </div>
  </div>
</div>

<!-- RESPOND PERMISSION -->
<div id="modalRespondPermission" class="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <h3>Répondre à la demande</h3>
      <button class="modal-close" onclick="closeModal('modalRespondPermission')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="permissionRespondId">
      <div class="form-group">
        <label>Décision</label>
        <select id="permissionStatus" class="form-select">
          <option value="approved">Approuver — Autorisation accordée</option>
          <option value="rejected">Refuser</option>
          <option value="more_info_needed">Demander des informations complémentaires</option>
        </select>
      </div>
      <div class="form-group">
        <label>Notes administratives</label>
        <textarea id="permissionNotes" class="field-input" rows="3" placeholder="Conditions, restrictions, instructions..."></textarea>
      </div>
      <div class="form-group" id="rejectionReasonGroup">
        <label>Motif de refus</label>
        <textarea id="permissionRejection" class="field-input" rows="2" placeholder="Expliquez le motif..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-btn" onclick="closeModal('modalRespondPermission')">Annuler</button>
      <button class="topbar-btn primary" onclick="submitPermissionResponse()">
        <i class="fas fa-check"></i> Enregistrer la décision
      </button>
    </div>
  </div>
</div>

<!-- ADD WHITELIST -->
<div id="modalAddWhitelist" class="modal-overlay">
  <div class="modal">
    <div class="modal-head">
      <h3>Ajouter un contenu autorisé</h3>
      <button class="modal-close" onclick="closeModal('modalAddWhitelist')"><i class="fas fa-times"></i></button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>Nom du bénéficiaire</label>
          <input type="text" id="wlName" class="field-input" placeholder="Nom complet">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="wlEmail" class="field-input" placeholder="email@exemple.com">
        </div>
      </div>
      <div class="form-group">
        <label>Organisation</label>
        <input type="text" id="wlOrg" class="field-input" placeholder="Nom de l'organisation (optionnel)">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Type de contenu</label>
          <select id="wlType" class="form-select">
            <option value="video">Vidéo</option>
            <option value="image">Image</option>
            <option value="article">Article</option>
            <option value="audio">Audio</option>
            <option value="site_web">Site Web</option>
            <option value="autre">Autre</option>
          </select>
        </div>
        <div class="form-group">
          <label>Date d'expiration</label>
          <input type="date" id="wlExpiry" class="field-input">
        </div>
      </div>
      <div class="form-group">
        <label>URL du contenu</label>
        <input type="url" id="wlUrl" class="field-input" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="wlDesc" class="field-input" rows="2" placeholder="Description de l'autorisation accordée..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="action-btn" onclick="closeModal('modalAddWhitelist')">Annuler</button>
      <button class="topbar-btn primary" onclick="submitWhitelist()">
        <i class="fas fa-plus"></i> Ajouter
      </button>
    </div>
  </div>
</div>

<script>
let adminToken = '';
let currentDocCaseId = null;
let sigDrawing = false;
let sigCtx = null;
let sigLastX = 0, sigLastY = 0;

// ===== AUTH =====
async function doLogin() {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  const err = document.getElementById('loginError');
  const btn = document.querySelector('.btn-login');
  err.classList.remove('show');
  if (!user || !pass) { err.textContent = 'Veuillez remplir tous les champs.'; err.classList.add('show'); return; }

  // Indicateur de chargement
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:8px;"></i>Connexion...';

  try {
    // Utilise fetch natif (plus fiable que axios CDN)
    const res = await fetch('/api/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username: user, password: pass })
    });
    const data = await res.json();
    if (data.success) {
      adminToken = data.token;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminApp').style.display = 'flex';
      document.getElementById('sidebarUserName').textContent = data.user.name;
      loadDashboard(); loadReports(); loadLegalCases(); loadPermissions(); loadWhitelist(); loadAlerts(); loadSubscribers();
      initSignaturePad();
    } else {
      err.textContent = data.error || 'Identifiants incorrects.';
      err.classList.add('show');
      document.getElementById('loginPass').value = '';
    }
  } catch(e) {
    err.textContent = 'Erreur de connexion. Veuillez réessayer.';
    err.classList.add('show');
    document.getElementById('loginPass').value = '';
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sign-in-alt" style="margin-right:8px;"></i>Se connecter';
  }
}

function doLogout() {
  adminToken = '';
  document.getElementById('adminApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
}

function authHeader() { return { Authorization: 'Bearer ' + adminToken }; }

// ===== NAVIGATION =====
function showSection(name, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (el) el.classList.add('active');
  const titles = {
    dashboard: 'Tableau de bord', reports: 'Signalements',
    legal: 'Dossiers juridiques', permissions: 'Demandes d\'autorisation',
    whitelist: 'Contenus autorisés', alerts: 'Alertes surveillance'
  };
  document.getElementById('topbarTitle').textContent = titles[name] || name;
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ===== DASHBOARD =====
async function loadDashboard() {
  try {
    const res = await axios.get('/api/admin/dashboard-stats', { headers: authHeader() });
    const d = res.data.data;
    document.getElementById('ds-total').textContent = d.total_reports;
    document.getElementById('ds-pending').textContent = d.pending_reports;
    document.getElementById('ds-resolved').textContent = d.resolved_reports;
    document.getElementById('ds-legal').textContent = d.legal_action;
    document.getElementById('ds-perms').textContent = d.permission_requests;
    document.getElementById('ds-auth').textContent = d.authorized_contents;
    document.getElementById('ds-cases').textContent = d.legal_cases;
    document.getElementById('ds-alerts').textContent = d.new_alerts;
    document.getElementById('ds-week').textContent = d.week_reports;
    document.getElementById('navBadgePending').textContent = d.pending_reports;

    const tbody = document.getElementById('dashboardRecentReports');
    if (d.recent_reports && d.recent_reports.length > 0) {
      tbody.innerHTML = d.recent_reports.map(r => `
        <tr>
          <td class="td-main">${r.ref_number}</td>
          <td>${r.platform || '—'}</td>
          <td>${r.abuse_type || '—'}</td>
          <td>${badgeStatus(r.status)}</td>
          <td>${formatDate(r.created_at)}</td>
        </tr>`).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state"><i class="fas fa-inbox"></i><p>Aucun signalement récent</p></div></td></tr>';
    }
  } catch(e) { console.error('Dashboard:', e.message); }
}

// ===== REPORTS =====
async function loadReports(status = '') {
  try {
    const res = await axios.get('/api/admin/reports' + (status ? '?status=' + status : ''), { headers: authHeader() });
    const tbody = document.getElementById('reportsTable');
    if (!res.data.data || res.data.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-flag"></i><p>Aucun signalement</p></div></td></tr>';
      return;
    }
    tbody.innerHTML = res.data.data.map(r => `
      <tr>
        <td class="td-main">${r.ref_number}</td>
        <td><div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${r.url || ''}">
          <span style="color:var(--gold);font-size:11px;">${r.platform || '—'}</span><br>
          <span style="font-size:12px;">${truncate(r.url || '', 30)}</span>
        </div></td>
        <td>${r.abuse_type || '—'}</td>
        <td><div style="font-size:12px;">${r.reporter_email || '—'}</div></td>
        <td>${badgePriority(r.priority)}</td>
        <td>${badgeStatus(r.status)}</td>
        <td>${formatDate(r.created_at)}</td>
        <td>
          <div style="display:flex;gap:6px;">
            <button class="action-btn primary-sm" onclick="openProcessReport(${r.id}, '${r.status}')">
              <i class="fas fa-edit"></i> Traiter
            </button>
            <button class="action-btn" onclick="openNewCaseFromReport(${r.id})">
              <i class="fas fa-gavel"></i>
            </button>
          </div>
        </td>
      </tr>`).join('');
  } catch(e) { console.error('Reports:', e.message); }
}

function openProcessReport(id, status) {
  document.getElementById('processReportId').value = id;
  document.getElementById('processStatus').value = status || 'processing';
  document.getElementById('processActions').value = '';
  document.getElementById('processNotes').value = '';
  document.getElementById('offenderName').value = '';
  document.getElementById('offenderEmail').value = '';
  openModal('modalProcessReport');
}

async function submitProcessReport() {
  const id = document.getElementById('processReportId').value;
  const data = {
    status: document.getElementById('processStatus').value,
    actions_taken: document.getElementById('processActions').value,
    admin_notes: document.getElementById('processNotes').value,
    offender_name: document.getElementById('offenderName').value,
    offender_email: document.getElementById('offenderEmail').value,
  };
  try {
    await axios.put('/api/admin/report/' + id + '/process', data, { headers: authHeader() });
    closeModal('modalProcessReport');
    loadReports(); loadDashboard();
    showToast('Signalement mis à jour avec succès.');
  } catch(e) { alert('Erreur: ' + (e.response?.data?.error || e.message)); }
}

function openNewCaseFromReport(reportId) {
  document.getElementById('caseReportId').value = reportId;
  openModal('modalNewCase');
}

// ===== LEGAL CASES =====
async function loadLegalCases() {
  try {
    const res = await axios.get('/api/admin/legal-cases', { headers: authHeader() });
    const tbody = document.getElementById('legalTable');
    if (!res.data.data || res.data.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-gavel"></i><p>Aucun dossier juridique</p></div></td></tr>';
      return;
    }
    const typeLabels = { mise_en_demeure: 'Mise en demeure', plainte_formelle: 'Plainte formelle', injonction: 'Injonction' };
    tbody.innerHTML = res.data.data.map(c => `
      <tr>
        <td class="td-main">${c.case_number}</td>
        <td>${typeLabels[c.case_type] || c.case_type}</td>
        <td>${c.offender_name || '—'}</td>
        <td>${c.report_platform || '—'}</td>
        <td>${c.status === 'signed' ? '<span class="badge badge-resolved">Signé</span>' : '<span class="badge badge-draft">Brouillon</span>'}</td>
        <td>${formatDate(c.created_at)}</td>
        <td>
          <div style="display:flex;gap:6px;">
            <button class="action-btn primary-sm" onclick="openViewDoc(${c.id})">
              <i class="fas fa-eye"></i> Voir
            </button>
          </div>
        </td>
      </tr>`).join('');
  } catch(e) { console.error('Legal:', e.message); }
}

async function submitNewCase() {
  const data = {
    report_id: document.getElementById('caseReportId').value,
    case_type: document.getElementById('caseType').value,
    offender_name: document.getElementById('caseOffenderName').value,
    offender_email: document.getElementById('caseOffenderEmail').value,
    offender_platform_id: document.getElementById('caseOffenderPlatformId').value,
  };
  if (!data.report_id) { alert('Veuillez entrer l\'ID du signalement.'); return; }
  try {
    const res = await axios.post('/api/admin/legal-case/create', data, { headers: authHeader() });
    closeModal('modalNewCase');
    loadLegalCases(); loadDashboard();
    showToast('Dossier ' + res.data.case_number + ' créé avec succès.');
  } catch(e) { alert('Erreur: ' + (e.response?.data?.error || e.message)); }
}

async function openViewDoc(id) {
  currentDocCaseId = id;
  // Ouvrir dans un nouvel onglet pour un rendu natif propre
  window.open('/api/admin/legal-case/' + id + '/html?token=' + encodeURIComponent(adminToken), '_blank');
  // Aussi charger dans l'iframe de prévisualisation
  document.getElementById('docPreviewArea').innerHTML = `
    <div style="margin-bottom:12px;display:flex;align-items:center;gap:10px;">
      <button class="doc-open-btn" onclick="window.open('/api/admin/legal-case/${id}/html?token=${encodeURIComponent(adminToken)}','_blank')">
        <i class="fas fa-external-link-alt"></i> Ouvrir en plein écran
      </button>
      <button class="doc-open-btn" onclick="printDoc(${id})">
        <i class="fas fa-print"></i> Imprimer
      </button>
      <span style="font-size:11px;color:var(--text-dim);">Dossier #${id}</span>
    </div>
    <iframe class="doc-iframe" src="/api/admin/legal-case/${id}/html?token=${encodeURIComponent(adminToken)}" title="Document juridique"></iframe>`;
  openModal('modalViewDoc');
}

async function printDoc(id) {
  const w = window.open('/api/admin/legal-case/' + id + '/html?token=' + encodeURIComponent(adminToken), '_blank');
  if (w) {
    w.addEventListener('load', () => { setTimeout(() => w.print(), 500); });
  }
}

function printCurrentDoc() {
  if (currentDocCaseId) {
    printDoc(currentDocCaseId);
  }
}

async function signCurrentDoc() {
  if (!currentDocCaseId) return;
  const canvas = document.getElementById('sigCanvas');
  const sigData = canvas.toDataURL('image/png');
  const sigText = 'Signé électroniquement — Administration de Sa Majesté Masambukidi I — E.LU.C.CO. — ' + new Date().toLocaleDateString('fr-FR');
  try {
    await axios.put('/api/admin/legal-case/' + currentDocCaseId + '/sign', {
      signature_data: sigText,
      signature_image: sigData
    }, { headers: authHeader() });
    closeModal('modalViewDoc');
    loadLegalCases();
    showToast('Document signé et archivé avec succès.');
  } catch(e) { alert('Erreur: ' + (e.response?.data?.error || e.message)); }
}

// ===== SIGNATURE PAD =====
function initSignaturePad() {
  const canvas = document.getElementById('sigCanvas');
  if (!canvas) return;
  sigCtx = canvas.getContext('2d');
  sigCtx.fillStyle = '#fff';
  sigCtx.fillRect(0, 0, canvas.width, canvas.height);
  sigCtx.strokeStyle = '#1a1a1a';
  sigCtx.lineWidth = 2;
  sigCtx.lineCap = 'round';
  sigCtx.lineJoin = 'round';

  canvas.addEventListener('mousedown', e => { sigDrawing = true; const r = canvas.getBoundingClientRect(); sigLastX = e.clientX - r.left; sigLastY = e.clientY - r.top; });
  canvas.addEventListener('mousemove', e => { if (!sigDrawing) return; const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left; const y = e.clientY - r.top; sigCtx.beginPath(); sigCtx.moveTo(sigLastX, sigLastY); sigCtx.lineTo(x, y); sigCtx.stroke(); sigLastX = x; sigLastY = y; });
  canvas.addEventListener('mouseup', () => sigDrawing = false);
  canvas.addEventListener('mouseleave', () => sigDrawing = false);

  canvas.addEventListener('touchstart', e => { e.preventDefault(); sigDrawing = true; const r = canvas.getBoundingClientRect(); sigLastX = e.touches[0].clientX - r.left; sigLastY = e.touches[0].clientY - r.top; });
  canvas.addEventListener('touchmove', e => { e.preventDefault(); if (!sigDrawing) return; const r = canvas.getBoundingClientRect(); const x = e.touches[0].clientX - r.left; const y = e.touches[0].clientY - r.top; sigCtx.beginPath(); sigCtx.moveTo(sigLastX, sigLastY); sigCtx.lineTo(x, y); sigCtx.stroke(); sigLastX = x; sigLastY = y; });
  canvas.addEventListener('touchend', () => sigDrawing = false);
}

function clearSignature() {
  if (!sigCtx) return;
  const c = document.getElementById('sigCanvas');
  sigCtx.fillStyle = '#fff';
  sigCtx.fillRect(0, 0, c.width, c.height);
}

// ===== PERMISSIONS =====
async function loadPermissions() {
  try {
    const res = await axios.get('/api/admin/permissions', { headers: authHeader() });
    const tbody = document.getElementById('permissionsTable');
    if (!res.data.data || res.data.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fas fa-file-signature"></i><p>Aucune demande d\'autorisation</p></div></td></tr>';
      return;
    }
    tbody.innerHTML = res.data.data.map(p => `
      <tr>
        <td class="td-main">${p.ticket_number}</td>
        <td>${p.requester_name}</td>
        <td>${p.requester_org || '—'}</td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.usage_purpose}</td>
        <td>${p.is_commercial ? '<span class="badge badge-warning" style="background:rgba(122,90,31,0.2);color:#FFBA00;border:1px solid rgba(122,90,31,0.3);">Commercial</span>' : 'Non'}</td>
        <td>${badgePermStatus(p.status)}</td>
        <td>${formatDate(p.created_at)}</td>
        <td>
          <button class="action-btn primary-sm" onclick="openRespondPermission(${p.id})">
            <i class="fas fa-reply"></i> Répondre
          </button>
        </td>
      </tr>`).join('');
  } catch(e) { console.error('Permissions:', e.message); }
}

function openRespondPermission(id) {
  document.getElementById('permissionRespondId').value = id;
  document.getElementById('permissionStatus').value = 'approved';
  document.getElementById('permissionNotes').value = '';
  document.getElementById('permissionRejection').value = '';
  openModal('modalRespondPermission');
}

async function submitPermissionResponse() {
  const id = document.getElementById('permissionRespondId').value;
  const data = {
    status: document.getElementById('permissionStatus').value,
    admin_notes: document.getElementById('permissionNotes').value,
    rejection_reason: document.getElementById('permissionRejection').value,
  };
  try {
    await axios.put('/api/admin/permission/' + id + '/respond', data, { headers: authHeader() });
    closeModal('modalRespondPermission');
    loadPermissions();
    showToast('Décision enregistrée avec succès.');
  } catch(e) { alert('Erreur: ' + (e.response?.data?.error || e.message)); }
}

// ===== WHITELIST =====
async function loadWhitelist() {
  try {
    const res = await axios.get('/api/authorized/list');
    const tbody = document.getElementById('whitelistTable');
    if (!res.data.data || res.data.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fas fa-shield-alt"></i><p>Aucun contenu autorisé</p></div></td></tr>';
      return;
    }
    tbody.innerHTML = res.data.data.map(w => `
      <tr>
        <td class="td-main" style="color:var(--gold);">${w.cert_number}</td>
        <td>${w.beneficiary_name}</td>
        <td>${w.content_type}</td>
        <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
          ${w.url ? '<a href="'+w.url+'" target="_blank" style="color:var(--text-muted);font-size:12px;">'+truncate(w.url, 30)+'</a>' : '—'}
        </td>
        <td>${w.date_expiration ? formatDate(w.date_expiration) : '<span style="color:#4CAF50;font-size:12px;">Illimitée</span>'}</td>
        <td>
          <button class="action-btn" style="font-size:11px;padding:5px 10px;"><i class="fas fa-certificate"></i> Certificat</button>
        </td>
      </tr>`).join('');
  } catch(e) { console.error('Whitelist:', e.message); }
}

async function submitWhitelist() {
  const data = {
    beneficiary_name: document.getElementById('wlName').value,
    beneficiary_email: document.getElementById('wlEmail').value,
    beneficiary_org: document.getElementById('wlOrg').value,
    content_type: document.getElementById('wlType').value,
    date_expiration: document.getElementById('wlExpiry').value || null,
    url: document.getElementById('wlUrl').value,
    description: document.getElementById('wlDesc').value,
    usage_purpose: document.getElementById('wlDesc').value,
  };
  if (!data.beneficiary_name || !data.content_type || !data.description) {
    alert('Veuillez remplir les champs obligatoires.'); return;
  }
  try {
    const res = await axios.post('/api/admin/whitelist/add', data, { headers: authHeader() });
    closeModal('modalAddWhitelist');
    loadWhitelist(); loadDashboard();
    showToast('Certificat ' + res.data.cert_number + ' créé.');
  } catch(e) { alert('Erreur: ' + (e.response?.data?.error || e.message)); }
}

// ===== ALERTS =====
async function loadAlerts() {
  try {
    const res = await axios.get('/api/monitor/alerts');
    const tbody = document.getElementById('alertsTable');
    if (!res.data.data || res.data.data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><i class="fas fa-bell"></i><p>Aucune alerte active — surveillance en cours</p></div></td></tr>';
      return;
    }
    tbody.innerHTML = res.data.data.map(a => `
      <tr>
        <td class="td-main">${a.keyword}</td>
        <td>${a.platform || '—'}</td>
        <td>${truncate(a.title_detected || '—', 40)}</td>
        <td>${a.url_detected ? '<a href="'+a.url_detected+'" target="_blank" style="color:var(--gold);font-size:12px;">Voir</a>' : '—'}</td>
        <td>${badgePriority(a.priority)}</td>
        <td>${formatDate(a.detected_at)}</td>
        <td>
          <button class="action-btn" onclick="openNewCaseFromReport(${a.id})"><i class="fas fa-gavel"></i></button>
        </td>
      </tr>`).join('');
  } catch(e) { console.error('Alerts:', e.message); }
}

async function loadSubscribers() {
  try {
    const res = await axios.get('/api/alerts/subscribers', { headers: authHeader() });
    const container = document.getElementById('subscribersContainer');
    if (!res.data.data || res.data.data.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);font-size:13px;"><i class="fas fa-users" style="margin-right:8px;"></i>Aucun abonné pour l\'instant.</div>';
      return;
    }
    container.innerHTML = `
      <div style="padding:12px 20px;font-size:13px;color:var(--text-muted);border-bottom:1px solid var(--border);">
        <strong style="color:var(--gold);">${res.data.count}</strong> abonné(s) actif(s)
      </div>
      <table><thead><tr><th>Email</th><th>Nom</th><th>Actif</th><th>Inscrit le</th></tr></thead>
      <tbody>${res.data.data.map(s => `
        <tr>
          <td>${s.email}</td>
          <td>${s.name || '—'}</td>
          <td>${s.is_active ? '<span style="color:#22c55e;font-size:12px;font-weight:700;">Oui</span>' : '<span style="color:#ef4444;font-size:12px;">Non</span>'}</td>
          <td>${formatDate(s.created_at)}</td>
        </tr>`).join('')}
      </tbody></table>`;
  } catch(e) { console.error('Subscribers:', e.message); }
}

async function broadcastAlert() {
  const keyword = document.getElementById('broadcastKeyword').value.trim();
  const platform = document.getElementById('broadcastPlatform').value;
  const title = document.getElementById('broadcastTitle').value.trim();
  const url = document.getElementById('broadcastUrl').value.trim();
  const desc = document.getElementById('broadcastDesc').value.trim();
  const status = document.getElementById('broadcastStatus');

  if (!keyword) { status.textContent = 'Veuillez entrer un mot-clé.'; status.style.color = '#ef4444'; return; }

  status.textContent = 'Envoi en cours...';
  status.style.color = 'var(--text-muted)';

  try {
    // Enregistrer l'alerte dans la base
    await axios.post('/api/monitor/add', {
      keyword, platform, url_detected: url, title_detected: title, description_detected: desc, priority: 'high'
    });
    // Diffuser aux abonnés
    const res = await axios.post('/api/alerts/broadcast', {
      keyword, platform, url, title, description: desc
    }, { headers: authHeader() });

    if (res.data.success) {
      status.textContent = `Alerte envoyée à ${res.data.sent}/${res.data.total} abonnés.`;
      status.style.color = '#22c55e';
      document.getElementById('broadcastKeyword').value = '';
      document.getElementById('broadcastTitle').value = '';
      document.getElementById('broadcastUrl').value = '';
      document.getElementById('broadcastDesc').value = '';
      loadAlerts();
    }
  } catch(e) {
    status.textContent = 'Erreur : ' + (e.response?.data?.error || e.message);
    status.style.color = '#ef4444';
  }
}

// ===== HELPERS =====
function badgeStatus(s) {
  const m = { pending: ['badge-pending','En attente'], processing: ['badge-processing','En cours'], resolved: ['badge-resolved','Résolu'], rejected: ['badge-rejected','Rejeté'], legal_action: ['badge-legal','Action légale'] };
  const [cls, lbl] = m[s] || ['badge-rejected', s];
  return '<span class="badge '+cls+'">'+lbl+'</span>';
}
function badgePermStatus(s) {
  const m = { pending: ['badge-pending','En attente'], reviewing: ['badge-processing','Examen'], approved: ['badge-resolved','Approuvée'], rejected: ['badge-rejected','Refusée'], more_info_needed: ['badge-draft','Info requise'] };
  const [cls, lbl] = m[s] || ['badge-rejected', s];
  return '<span class="badge '+cls+'">'+lbl+'</span>';
}
function badgePriority(p) {
  const m = { critical: ['badge-legal','Critique'], high: ['badge-pending','Haute'], normal: ['badge-processing','Normale'] };
  const [cls, lbl] = m[p] || ['badge-draft', p];
  return '<span class="badge '+cls+'">'+lbl+'</span>';
}
function truncate(str, n) { return str && str.length > n ? str.substring(0, n) + '...' : str; }
function formatDate(d) {
  if (!d) return '—';
  try { return new Date(d).toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' }); }
  catch { return d; }
}

let toastTimer;
function showToast(msg, type = 'success') {
  let t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--bg-card);border:1px solid rgba(201,162,39,0.3);color:var(--text);padding:14px 20px;border-radius:10px;font-size:13px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.4);display:flex;align-items:center;gap:10px;max-width:400px;transition:opacity 0.3s;';
    document.body.appendChild(t);
  }
  const icon = type === 'error' ? '<i class="fas fa-exclamation-circle" style="color:#ef4444;"></i>' : '<i class="fas fa-check-circle" style="color:#4CAF50;"></i>';
  t.innerHTML = icon + msg;
  t.style.opacity = '1';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.style.opacity = '0'; }, 4000);
}

// ===== HORLOGE DASHBOARD =====
function updateAdminClock() {
  const el = document.getElementById('adminClockBanner');
  if (!el) return;
  const now = new Date();
  el.textContent = now.toLocaleDateString('fr-FR', { weekday:'short', day:'2-digit', month:'short', year:'numeric' }) + ' · ' + now.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
}
setInterval(updateAdminClock, 1000);
updateAdminClock();
</script>

</body>
</html>
